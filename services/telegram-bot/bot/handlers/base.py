import logging
from aiogram import Dispatcher, Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext

from keyboards.reply import get_main_keyboard, get_classes_info_keyboard
from utils.messages import get_welcome_message

logger = logging.getLogger(__name__)
router = Router()


@router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    await state.clear()
    
    welcome_text = get_welcome_message(message.from_user.first_name)
    keyboard = get_main_keyboard()
    
    await message.answer(
        welcome_text,
        reply_markup=keyboard
    )
    
    logger.info(f"User {message.from_user.id} started the bot")


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """
ü§ñ <b>–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞</b>

üì∏ <b>–ö–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</b>
‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, JPEG, PNG, WEBP
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 10MB
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∑–∞ —Ä–∞–∑

üè† <b>–ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:</b>
‚Ä¢ –¢–∏–ø –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã
‚Ä¢ –ö–ª–∞—Å—Å –ø–æ–º–µ—â–µ–Ω–∏—è (A0, A1, B0, B1, C0, C1, D0, D1)
‚Ä¢ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞

üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b>
‚Ä¢ –ö–ª–∞—Å—Å –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é
‚Ä¢ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π –ø–æ –≤—Å–µ–º –∫–ª–∞—Å—Å–∞–º

üí° <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
    """
    
    await message.answer(help_text, parse_mode="HTML")


@router.message(Command("cancel"))
async def cmd_cancel(message: Message, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è"""
    await state.clear()
    keyboard = get_main_keyboard()
    
    await message.answer(
        "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard
    )


@router.message(F.text == "üì∏ –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
async def handle_classify_button(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    await message.answer(
        "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.\n\n"
        "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: JPG, JPEG, PNG, WEBP\n"
        "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB\n"
        "–ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ."
    )


@router.message(F.text == "‚ÑπÔ∏è –ü–æ–º–æ—â—å")
async def handle_help_button(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–º–æ—â–∏"""
    await cmd_help(message)


@router.message(F.text == "üè† –û –∫–ª–∞—Å—Å–∞—Ö –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤")
async def handle_classes_info_button(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∞—Å—Å–∞—Ö"""
    keyboard = get_classes_info_keyboard()
    
    await message.answer(
        "üè† <b>–ö–ª–∞—Å—Å—ã –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ –∫–≤–∞—Ä—Ç–∏—Ä</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:",
        reply_markup=keyboard,
        parse_mode="HTML"
    )


@router.callback_query(F.data.startswith("class_info_"))
async def handle_class_info_callback(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∞—Å—Å–∞—Ö"""
    class_type = callback.data.split("_")[-1]
    
    class_info = {
        "a": """
üè¢ <b>–ö–ª–∞—Å—Å—ã A - –≠–ª–∏—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä—å–µ—Ä—ã</b>

<b>A0:</b> –ü—Ä–µ–º–∏—É–º —ç–ª–∏—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—å–µ—Ä
‚Ä¢ –í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∞—è –º–µ–±–µ–ª—å
‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
‚Ä¢ –ü—Ä–æ—Å—Ç–æ—Ä–Ω—ã–µ –ø–æ–º–µ—â–µ–Ω–∏—è

<b>A1:</b> –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —ç–ª–∏—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—å–µ—Ä
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –°—Ç–∏–ª—å–Ω–∞—è –º–µ–±–µ–ª—å
‚Ä¢ –•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
‚Ä¢ –ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
        """,
        "b": """
üè† <b>–ö–ª–∞—Å—Å—ã B - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä—å–µ—Ä—ã</b>

<b>B0:</b> –í—ã—Å–æ–∫–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç
‚Ä¢ –•–æ—Ä–æ—à–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ–±–µ–ª—å
‚Ä¢ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –£—é—Ç–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞

<b>B1:</b> –ë–∞–∑–æ–≤—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–Ω–∞—è –º–µ–±–µ–ª—å
‚Ä¢ –£–¥–æ–±–Ω–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞
‚Ä¢ –ö–æ–º—Ñ–æ—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
        """,
        "c": """
üèòÔ∏è <b>–ö–ª–∞—Å—Å—ã C - –≠–∫–æ–Ω–æ–º–Ω—ã–µ –∏–Ω—Ç–µ—Ä—å–µ—Ä—ã</b>

<b>C0:</b> –í—ã—Å–æ–∫–∏–π —ç–∫–æ–Ω–æ–º
‚Ä¢ –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –º–µ–±–µ–ª—å
‚Ä¢ –†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –£–¥–æ–±—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

<b>C1:</b> –ë–∞–∑–æ–≤—ã–π —ç–∫–æ–Ω–æ–º
‚Ä¢ –ü—Ä–æ—Å—Ç—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –ù–µ–æ–±—Ö–æ–¥–∏–º–∞—è –º–µ–±–µ–ª—å
‚Ä¢ –ü—Ä–æ—Å—Ç–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞
‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ —É–¥–æ–±—Å—Ç–≤–∞
        """,
        "d": """
üèöÔ∏è <b>–ö–ª–∞—Å—Å—ã D - –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä—å–µ—Ä—ã</b>

<b>D0:</b> –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–º—Ñ–æ—Ä—Ç
‚Ä¢ –ü—Ä–æ—Å—Ç—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –ë–∞–∑–æ–≤–∞—è –º–µ–±–µ–ª—å
‚Ä¢ –ü—Ä–æ—Å—Ç–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

<b>D1:</b> –ë–∞–∑–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è
‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ –ù–µ–æ–±—Ö–æ–¥–∏–º–∞—è –º–µ–±–µ–ª—å
‚Ä¢ –ü—Ä–æ—Å—Ç–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞
‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ —É–¥–æ–±—Å—Ç–≤–∞
        """
    }
    
    info = class_info.get(class_type, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
    
    await callback.message.edit_text(
        info,
        parse_mode="HTML"
    )
    
    await callback.answer()


def register_base_handlers(dp: Dispatcher) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤"""
    dp.include_router(router) 